<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>English Pronunciation Practice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-cognitiveservices-speech-sdk/1.32.0/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>
    <style>
        /* 이전 스타일 유지 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .practice-text {
            font-size: 20px;
            margin: 20px 0;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 8px;
            line-height: 1.6;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #ccc;
        }
        .status {
            margin: 10px 0;
            color: #666;
        }
        .timer {
            font-size: 20px;
            color: #dc3545;
            margin: 10px 0;
            font-weight: bold;
        }
        .volume-indicator {
            width: 300px;
            height: 20px;
            background-color: #eee;
            margin: 10px 0;
            border-radius: 10px;
            overflow: hidden;
        }
        .volume-bar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.1s;
        }
        .result-container {
            margin-top: 20px;
        }
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .feedback {
            margin: 10px 0;
            color: #666;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>English Pronunciation Practice</h1>
        
        <div class="practice-text">
            The importance of clear communication cannot be overstated in today's global world. When speaking English, proper pronunciation helps ensure your message is understood correctly. Practice speaking clearly and confidently, paying attention to the rhythm and intonation of your words.
        </div>

        <div class="button-container">
            <button id="playNative">Play Native Speaker</button>
            <button id="startRecording">Start Speaking (30s)</button>
            <button id="stopRecording" disabled>Stop Recording</button>
        </div>

        <div id="timer" class="timer"></div>
        <div id="status" class="status"></div>

        <div id="volumeIndicator" class="volume-indicator">
            <div id="volumeBar" class="volume-bar"></div>
        </div>

        <div id="resultContainer" class="result-container">
            <div id="pronunciationScore" class="score"></div>
            <div id="feedback" class="feedback"></div>
            <canvas id="pronunciationChart" class="chart-container"></canvas>
        </div>
    </div>

    <script>
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.apiKey, config.region);
        speechConfig.speechRecognitionLanguage = 'en-US';

        // Audio context initialization
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let isRecording = false;
        let timeLeft;
        let recordingTimer;
        let currentChart = null;

        const practiceText = "The importance of clear communication cannot be overstated in today's global world. When speaking English, proper pronunciation helps ensure your message is understood correctly. Practice speaking clearly and confidently, paying attention to the rhythm and intonation of your words.";

        // Native Speaker 재생
        document.getElementById('playNative').onclick = () => {
            const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);
            // 긴 문장을 위해 SSML 사용
            const ssml = `
                <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
                    <voice name="en-US-JennyNeural">
                        <prosody rate="0.9">
                            ${practiceText}
                        </prosody>
                    </voice>
                </speak>`;
            
            synthesizer.speakSsmlAsync(
                ssml,
                result => {
                    if (result) {
                        synthesizer.close();
                    }
                },
                error => {
                    console.log(error);
                    synthesizer.close();
                });
        };

        // 나머지 코드는 이전과 동일...
        
        // 타이머 함수
        function updateTimer() {
            document.getElementById('timer').textContent = `Time remaining: ${timeLeft}s`;
            if (timeLeft <= 0) {
                stopRecording();
            } else {
                timeLeft--;
            }
        }

        // Initialize audio context
        async function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.minDecibels = -90;
            analyser.maxDecibels = -10;
            analyser.smoothingTimeConstant = 0.85;
        }

        // Start recording
        async function startRecording() {
            if (!audioContext) {
                await initAudioContext();
            }
            
            timeLeft = 30;
            updateTimer();
            recordingTimer = setInterval(updateTimer, 1000);
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            updateVolumeIndicator(stream);
            
            const audioConfig = SpeechSDK.AudioConfig.fromStreamInput(stream);
            const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
            
            isRecording = true;
            document.getElementById('startRecording').disabled = true;
            document.getElementById('stopRecording').disabled = false;
            document.getElementById('status').textContent = 'Recording... Speak now!';
            
            recognizer.recognizing = (s, e) => {
                document.getElementById('status').textContent = `Recognizing: ${e.result.text}`;
            };
            
            recognizer.recognized = (s, e) => {
                if (e.result.text) {
                    analyzePronunciation(e.result);
                }
            };
            
            recognizer.startContinuousRecognitionAsync();
        }

        // 나머지 함수들 (stopRecording, analyzePronunciation 등)은 이전과 동일...

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startRecording').addEventListener('click', startRecording);
            document.getElementById('stopRecording').addEventListener('click', stopRecording);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</body>
</html>
