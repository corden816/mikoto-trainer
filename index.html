<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>English Pronunciation Practice</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        /* 기존 스타일 유지 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        /* ... 기존 스타일 ... */
        
        /* 파형 그래프를 위한 새로운 스타일 */
        .waveform-container {
            width: 100%;
            height: 100px;
            background-color: #f0f0f0;
            margin: 20px 0;
            border-radius: 8px;
            position: relative;
        }
        
        #waveformCanvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 기존 HTML 구조 유지 -->
        
        <!-- 파형 그래프를 위한 새로운 컨테이너 추가 -->
        <div class="waveform-container">
            <canvas id="waveformCanvas"></canvas>
        </div>
        
        <div id="resultContainer" class="result-container">
            <div id="pronunciationScore" class="score"></div>
            <div id="feedback" class="feedback"></div>
            <canvas id="pronunciationChart" class="chart-container"></canvas>
        </div>
    </div>

    <script>
        window.onload = async function() {
            // Speech SDK 초기화
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.apiKey, config.region);
            speechConfig.speechRecognitionLanguage = 'en-US';

            // 발음 평가 설정
            const practiceText = "The importance of clear communication cannot be overstated in today's global world. When speaking English, proper pronunciation helps ensure your message is understood correctly. Practice speaking clearly and confidently, paying attention to the rhythm and intonation of your words.";
            
            const pronunciationAssessmentConfig = new SpeechSDK.PronunciationAssessmentConfig(
                practiceText,
                SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
                SpeechSDK.PronunciationAssessmentGranularity.Word,
                true
            );

            let audioContext;
            let analyser;
            let waveformCanvas;
            let waveformCtx;
            let animationId;
            
            // 파형 그래프 초기화
            function initWaveform() {
                waveformCanvas = document.getElementById('waveformCanvas');
                waveformCtx = waveformCanvas.getContext('2d');
                
                // 캔버스 크기 설정
                waveformCanvas.width = waveformCanvas.offsetWidth;
                waveformCanvas.height = waveformCanvas.offsetHeight;
            }

            // 파형 그리기
            function drawWaveform(dataArray) {
                waveformCtx.fillStyle = '#f0f0f0';
                waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
                
                waveformCtx.lineWidth = 2;
                waveformCtx.strokeStyle = '#4CAF50';
                waveformCtx.beginPath();

                const sliceWidth = waveformCanvas.width / dataArray.length;
                let x = 0;

                for (let i = 0; i < dataArray.length; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * waveformCanvas.height) / 2;

                    if (i === 0) {
                        waveformCtx.moveTo(x, y);
                    } else {
                        waveformCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
                waveformCtx.stroke();
            }

            // 녹음 시작
            async function startRecording() {
                try {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 2048;
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaStreamSource = audioContext.createMediaStreamSource(stream);
                    mediaStreamSource.connect(analyser);

                    // 파형 업데이트
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    function updateWaveform() {
                        animationId = requestAnimationFrame(updateWaveform);
                        analyser.getByteTimeDomainData(dataArray);
                        drawWaveform(dataArray);
                    }
                    updateWaveform();

                    // Speech SDK 설정
                    const audioConfig = SpeechSDK.AudioConfig.fromStreamInput(stream);
                    const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                    pronunciationAssessmentConfig.applyTo(recognizer);

                    recognizer.recognized = (s, e) => {
                        if (e.result.text) {
                            const pronunciationResult = JSON.parse(
                                e.result.properties.getProperty(SpeechSDK.PropertyId.SpeechServiceResponse_JsonResult)
                            );

                            // 점수 계산 및 표시
                            const accuracyScore = pronunciationResult.NBest[0].PronunciationAssessment.AccuracyScore;
                            const fluencyScore = pronunciationResult.NBest[0].PronunciationAssessment.FluencyScore;
                            const completenessScore = pronunciationResult.NBest[0].PronunciationAssessment.CompletenessScore;
                            
                            const overallScore = Math.round((accuracyScore + fluencyScore + completenessScore) / 3);
                            
                            document.getElementById('pronunciationScore').textContent = 
                                `Overall Score: ${overallScore}%\n` +
                                `Accuracy: ${accuracyScore}%\n` +
                                `Fluency: ${fluencyScore}%\n` +
                                `Completeness: ${completenessScore}%`;
                        }
                    };

                    recognizer.startContinuousRecognitionAsync();
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            // 녹음 중지
            function stopRecording() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
            }

            // 이벤트 리스너 설정
            initWaveform();
            document.getElementById('startRecording').addEventListener('click', startRecording);
            document.getElementById('stopRecording').addEventListener('click', stopRecording);
            
            // TTS 설정
            document.getElementById('playNative').onclick = () => {
                const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);
                const ssml = `
                    <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
                        <voice name="en-US-JennyNeural">
                            <prosody rate="0.9">${practiceText}</prosody>
                        </voice>
                    </speak>`;
                
                synthesizer.speakSsmlAsync(
                    ssml,
                    result => {
                        synthesizer.close();
                    },
                    error => {
                        console.log(error);
                        synthesizer.close();
                    });
            };
        };
    </script>
</body>
</html>
