<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pronunciation Practice</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 이전 CSS 스타일 유지 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .practice-text {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.2em;
            text-align: center;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .btn {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin: 10px 0;
            color: #666;
        }

        .volume-indicator {
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .volume-bar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.1s ease;
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .score {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .feedback {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        .chart-container {
            margin-top: 20px;
            height: 300px;
        }

        /* 샘플 선택 버튼 스타일 추가 */
        .sample-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .sample-btn {
            padding: 5px 15px;
            border: 2px solid #007bff;
            border-radius: 5px;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sample-btn.active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>English Pronunciation Practice</h1>

        <!-- 샘플 선택 버튼 추가 -->
        <div class="sample-selector">
            <button class="sample-btn active" data-sample="1">Sample 1</button>
            <button class="sample-btn" data-sample="2">Sample 2</button>
            <button class="sample-btn" data-sample="3">Sample 3</button>
            <button class="sample-btn" data-sample="4">Sample 4</button>
            <button class="sample-btn" data-sample="5">Sample 5</button>
        </div>

        <div class="practice-text">
            Sample text will be displayed here
        </div>

        <div class="button-container">
            <button id="playNative" class="btn">Play Native Speaker</button>
            <button id="startRecording" class="btn">Start Speaking</button>
        </div>

        <div id="status" class="status"></div>

        <div id="volumeIndicator" class="volume-indicator">
            <div id="volumeBar" class="volume-bar"></div>
        </div>

        <div id="resultContainer" class="result-container">
            <div id="pronunciationScore" class="score"></div>
            <div id="feedback" class="feedback"></div>
            <div class="chart-container">
                <canvas id="pronunciationChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "fad4e222a3854bb99ed337f837a4e21c",
            region: "koreacentral"
        };

        // Global variables
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let speechConfig;
        let audioConfig;
        let recognizer;
        let isRecording = false;
        let currentAudio = null;
        let currentSample = 1;

        // 샘플 텍스트 (나중에 실제 텍스트로 교체)
        const sampleTexts = {
            1: "Sample text 1",
            2: "Sample text 2",
            3: "Sample text 3",
            4: "Sample text 4",
            5: "Sample text 5"
        };

        // Initialize audio context
        async function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.minDecibels = -90;
            analyser.maxDecibels = -10;
            analyser.smoothingTimeConstant = 0.85;
        }

        // Initialize Azure Speech SDK
        function initSpeechSDK() {
            speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.apiKey, config.region);
            speechConfig.speechRecognitionLanguage = "en-US";
        }

        // Play native speaker audio
        function playNativeSpeaker() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const audioUrl = `https://raw.githubusercontent.com/corden816/mikoto-trainer/main/native-speaker${currentSample}.mp3`;
            currentAudio = new Audio(audioUrl);
            
            document.getElementById('playNative').disabled = true;
            
            currentAudio.play().catch(error => {
                console.error('Error playing audio:', error);
                document.getElementById('playNative').disabled = false;
            });

            currentAudio.onended = () => {
                document.getElementById('playNative').disabled = false;
            };
        }

        // 샘플 변경 함수
        function changeSample(sampleNumber) {
            currentSample = sampleNumber;
            document.querySelector('.practice-text').textContent = sampleTexts[sampleNumber];
            
            // 버튼 스타일 업데이트
            document.querySelectorAll('.sample-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sample === String(sampleNumber)) {
                    btn.classList.add('active');
                }
            });

            // 기존 오디오 정지
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }

        // Update volume indicator
        function updateVolumeIndicator(stream) {
            mediaStreamSource = audioContext.createMediaStreamSource(stream);
            mediaStreamSource.connect(analyser);
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function draw() {
                if (!isRecording) return;
                
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                const volume = Math.min(100, Math.max(0, average * 2));
                
                document.getElementById('volumeBar').style.width = volume + '%';
            }
            
            draw();
        }

        // Start recording
        async function startRecording() {
            if (!audioContext) {
                await initAudioContext();
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateVolumeIndicator(stream);

                const referenceText = document.querySelector('.practice-text').textContent;
                
                // Create pronunciation assessment config
                const pronunciationAssessmentConfig = new SpeechSDK.PronunciationAssessmentConfig(
                    referenceText,
                    SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
                    SpeechSDK.PronunciationAssessmentGranularity.Word,
                    true
                );
                
                audioConfig = SpeechSDK.AudioConfig.fromStreamInput(stream);
                recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                
                // Apply pronunciation assessment config
                pronunciationAssessmentConfig.applyTo(recognizer);
                
                isRecording = true;
                document.getElementById('startRecording').disabled = true;
                document.getElementById('status').textContent = 'Recording... Speak now!';
                
                recognizer.recognizing = (s, e) => {
                    document.getElementById('status').textContent = `Recognizing: ${e.result.text}`;
                };
                
                recognizer.recognized = (s, e) => {
                    if (e.result.text) {
                        const pronunciationResult = SpeechSDK.PronunciationAssessmentResult.fromResult(e.result);
                        analyzePronunciation(pronunciationResult);
                    }
                };
                
                recognizer.startContinuousRecognitionAsync();
                
                // Stop recording after 5 seconds
                setTimeout(stopRecording, 5000);
            } catch (error) {
                console.error('Error starting recording:', error);
                document.getElementById('status').textContent = 'Error accessing microphone';
            }
        }

        // Stop recording
        function stopRecording() {
            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync();
                isRecording = false;
                document.getElementById('startRecording').disabled = false;
                document.getElementById('status').textContent = 'Recording stopped';
                
                if (mediaStreamSource) {
                    mediaStreamSource.disconnect();
                }
            }
        }

        // Analyze pronunciation
        function analyzePronunciation(pronunciationResult) {
            const accuracyScore = pronunciationResult.accuracyScore;
            const fluencyScore = pronunciationResult.fluencyScore;
            const pronunciationScore = pronunciationResult.pronunciationScore;
            const completenessScore = pronunciationResult.completenessScore;
            
            const overallScore = Math.round((accuracyScore + fluencyScore + pronunciationScore + completenessScore) / 4);
            
            document.getElementById('pronunciationScore').textContent = `Pronunciation Score: ${overallScore}%`;
            
            let feedback = '';
            if (overallScore >= 90) {
                feedback = 'Excellent! Native-like pronunciation.';
            } else if (overallScore >= 70) {
                feedback = 'Good pronunciation. Keep practicing!';
            } else {
                feedback = 'Need more practice. Try listening to the native speaker again.';
            }
            
            document.getElementById('feedback').textContent = feedback;
            
            updateChart({
                accuracy: accuracyScore,
                fluency: fluencyScore,
                pronunciation: pronunciationScore,
                completeness: completenessScore,
                overall: overallScore
            });
        }

        // Update chart
        function updateChart(scores) {
            const ctx = document.getElementById('pronunciationChart').getContext('2d');
            
            if (window.pronunciationChart) {
                window.pronunciationChart.destroy();
            }
            
            window.pronunciationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Accuracy', 'Fluency', 'Pronunciation', 'Completeness', 'Overall'],
                    datasets: [{
                        label: 'Pronunciation Scores',
                        data: [
                            scores.accuracy,
                            scores.fluency,
                            scores.pronunciation,
                            scores.completeness,
                            scores.overall
                        ],
                        backgroundColor: [
                            '#007bff',
                            '#28a745',
                            '#ffc107',
                            '#17a2b8',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechSDK();
            
            // 초기 샘플 설정
            changeSample(1);
            
            // 이벤트 리스너 설정
            document.getElementById('playNative').addEventListener('click', playNativeSpeaker);
            document.getElementById('startRecording').addEventListener('click', startRecording);
            
            // 샘플 선택 버튼 이벤트 리스너
            document.querySelectorAll('.sample-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sampleNumber = parseInt(e.target.dataset.sample);
                    changeSample(sampleNumber);
                });
            });
        });
    </script>
</body>
</html>
