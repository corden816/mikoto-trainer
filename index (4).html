import React, { useState, useRef, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Mic, PlayCircle, StopCircle } from 'lucide-react';

// Azure Speech SDK를 전역 객체로 사용
const SpeechSDK = window.SpeechSDK;

const PronunciationTrainer = () => {
  const [selectedSample, setSelectedSample] = useState(1);
  const [isRecording, setIsRecording] = useState(false);
  const [timer, setTimer] = useState(30);
  const [isPlaying, setIsPlaying] = useState(false);
  const [score, setScore] = useState(null);
  const [audioLevel, setAudioLevel] = useState(0);
  const [detailedResults, setDetailedResults] = useState(null);
  
  const speechConfig = useRef(null);
  const audioConfig = useRef(null);
  const recognizer = useRef(null);
  
  const samples = [
    { id: 1, text: "Sample text 1 for pronunciation practice." },
    { id: 2, text: "Sample text 2 for pronunciation practice." },
    { id: 3, text: "Sample text 3 for pronunciation practice." },
    { id: 4, text: "Sample text 4 for pronunciation practice." },
    { id: 5, text: "Sample text 5 for pronunciation practice." }
  ];

  useEffect(() => {
    try {
      const subscriptionKey = "YOUR_AZURE_KEY";
      const region = "YOUR_REGION";
      
      if (SpeechSDK) {
        speechConfig.current = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, region);
        speechConfig.current.speechRecognitionLanguage = "en-US";
      }
    } catch (error) {
      console.error('Error initializing Speech SDK:', error);
    }

    return () => {
      if (recognizer.current) {
        recognizer.current.close();
      }
    };
  }, []);

  useEffect(() => {
    let interval;
    if (isRecording && timer > 0) {
      interval = setInterval(() => {
        setTimer(prev => prev - 1);
      }, 1000);
    } else if (timer === 0) {
      stopRecording();
    }
    return () => clearInterval(interval);
  }, [isRecording, timer]);

  const playNativeSpeaker = async () => {
    try {
      if (!speechConfig.current) {
        console.error('Speech config not initialized');
        return;
      }

      setIsPlaying(true);
      const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig.current);
      const currentText = samples.find(s => s.id === selectedSample)?.text;

      const result = await new Promise((resolve, reject) => {
        synthesizer.speakTextAsync(
          currentText,
          result => {
            synthesizer.close();
            resolve(result);
          },
          error => {
            synthesizer.close();
            reject(error);
          }
        );
      });

      setIsPlaying(false);
    } catch (error) {
      console.error('Error playing audio:', error);
      setIsPlaying(false);
    }
  };

  const startRecording = async () => {
    try {
      if (!speechConfig.current || !SpeechSDK) {
        console.error('Speech SDK not initialized');
        return;
      }

      const currentText = samples.find(s => s.id === selectedSample)?.text;
      
      // 발음 평가 설정
      const pronunciationAssessmentConfig = new SpeechSDK.PronunciationAssessmentConfig(
        currentText,
        SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
        SpeechSDK.PronunciationAssessmentGranularity.Word,
        true
      );

      audioConfig.current = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
      recognizer.current = new SpeechSDK.SpeechRecognizer(
        speechConfig.current,
        audioConfig.current
      );

      pronunciationAssessmentConfig.applyTo(recognizer.current);

      // 마이크 스트림 설정
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);

      // 오디오 레벨 모니터링
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      const checkAudioLevel = () => {
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        setAudioLevel(average);
        if (isRecording) {
          requestAnimationFrame(checkAudioLevel);
        }
      };
      checkAudioLevel();

      // 음성 인식 이벤트 설정
      recognizer.current.recognized = (s, e) => {
        if (e.result.text) {
          const pronunciationResult = SpeechSDK.PronunciationAssessmentResult.fromResult(e.result);
          
          setScore(pronunciationResult.pronunciationScore);
          setDetailedResults({
            accuracyScore: pronunciationResult.accuracyScore,
            fluencyScore: pronunciationResult.fluencyScore,
            completenessScore: pronunciationResult.completenessScore,
            prosodyScore: pronunciationResult.prosodyScore
          });
        }
      };

      await recognizer.current.startContinuousRecognitionAsync();
      setIsRecording(true);
      setTimer(30);
      
    } catch (err) {
      console.error('Error starting recording:', err);
    }
  };

  const stopRecording = async () => {
    try {
      if (recognizer.current) {
        await recognizer.current.stopContinuousRecognitionAsync();
        setIsRecording(false);
        setTimer(30);
      }
    } catch (error) {
      console.error('Error stopping recording:', error);
    }
  };

  // JSX 부분은 이전과 동일...
  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle className="text-2xl text-center">English Pronunciation Practice</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-6">
          {/* Sample Selection */}
          <div className="flex gap-2 flex-wrap justify-center">
            {samples.map(sample => (
              <Button
                key={sample.id}
                variant={selectedSample === sample.id ? "default" : "outline"}
                onClick={() => setSelectedSample(sample.id)}
              >
                Sample {sample.id}
              </Button>
            ))}
          </div>

          {/* Practice Text */}
          <div className="border rounded-lg p-4 bg-gray-50">
            <p className="text-lg text-center">
              {samples.find(s => s.id === selectedSample)?.text}
            </p>
          </div>

          {/* Controls */}
          <div className="flex justify-center gap-4">
            <Button
              onClick={playNativeSpeaker}
              disabled={isRecording || isPlaying}
              className="flex items-center gap-2"
            >
              <PlayCircle className="w-5 h-5" />
              Play Native Speaker
            </Button>
            
            {!isRecording ? (
              <Button
                onClick={startRecording}
                disabled={isPlaying}
                className="flex items-center gap-2"
              >
                <Mic className="w-5 h-5" />
                Start Speaking ({timer}s)
              </Button>
            ) : (
              <Button
                onClick={stopRecording}
                variant="destructive"
                className="flex items-center gap-2"
              >
                <StopCircle className="w-5 h-5" />
                Stop Recording
              </Button>
            )}
          </div>

          {/* Audio Level Indicator */}
          <div className="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
            <div
              className="h-full bg-blue-500 transition-all duration-100"
              style={{ width: `${(audioLevel / 255) * 100}%` }}
            />
          </div>

          {/* Detailed Results */}
          {detailedResults && (
            <div className="space-y-4">
              <div className="text-2xl font-bold text-center">
                Overall Score: {score?.toFixed(1)}%
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="border rounded p-3">
                  <div className="font-semibold">Accuracy</div>
                  <div className="text-xl">{detailedResults.accuracyScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Fluency</div>
                  <div className="text-xl">{detailedResults.fluencyScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Completeness</div>
                  <div className="text-xl">{detailedResults.completenessScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Prosody (Intonation)</div>
                  <div className="text-xl">{detailedResults.prosodyScore?.toFixed(1)}%</div>
                </div>
              </div>
              <div className="text-center text-gray-600">
                {score >= 90 ? 'Excellent pronunciation!' :
                 score >= 80 ? 'Very good pronunciation!' :
                 score >= 70 ? 'Good pronunciation, keep practicing!' :
                 'Keep practicing to improve your pronunciation!'}
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
};

export default PronunciationTrainer;
