import React, { useState, useRef, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Mic, PlayCircle, StopCircle } from 'lucide-react';
import * as sdk from 'microsoft-cognitiveservices-speech-sdk';

const PronunciationTrainer = () => {
  const [selectedSample, setSelectedSample] = useState(1);
  const [isRecording, setIsRecording] = useState(false);
  const [timer, setTimer] = useState(30);
  const [isPlaying, setIsPlaying] = useState(false);
  const [score, setScore] = useState(null);
  const [audioLevel, setAudioLevel] = useState(0);
  const [detailedResults, setDetailedResults] = useState(null);
  
  // Azure Speech SDK configurations
  const speechConfig = useRef(null);
  const audioConfig = useRef(null);
  const recognizer = useRef(null);
  
  const samples = [
    { id: 1, text: "Sample text 1 for pronunciation practice." },
    { id: 2, text: "Sample text 2 for pronunciation practice." },
    { id: 3, text: "Sample text 3 for pronunciation practice." },
    { id: 4, text: "Sample text 4 for pronunciation practice." },
    { id: 5, text: "Sample text 5 for pronunciation practice." }
  ];

  // Initialize Azure Speech Service
  useEffect(() => {
    const subscriptionKey = "YOUR_AZURE_KEY"; // Azure 키를 여기에 입력
    const region = "YOUR_REGION"; // Azure 리전을 여기에 입력
    
    speechConfig.current = sdk.SpeechConfig.fromSubscription(subscriptionKey, region);
    speechConfig.current.speechRecognitionLanguage = "en-US";
    
    return () => {
      if (recognizer.current) {
        recognizer.current.close();
      }
    };
  }, []);

  useEffect(() => {
    let interval;
    if (isRecording && timer > 0) {
      interval = setInterval(() => {
        setTimer(prev => prev - 1);
      }, 1000);
    } else if (timer === 0) {
      stopRecording();
    }
    return () => clearInterval(interval);
  }, [isRecording, timer]);

  const playNativeSpeaker = () => {
    // TTS 구현
    const synthesizer = new sdk.SpeechSynthesizer(speechConfig.current);
    const currentText = samples.find(s => s.id === selectedSample)?.text;
    
    synthesizer.speakTextAsync(
      currentText,
      result => {
        synthesizer.close();
        setIsPlaying(false);
      },
      error => {
        console.log(error);
        synthesizer.close();
        setIsPlaying(false);
      }
    );
    
    setIsPlaying(true);
  };

  const startRecording = async () => {
    try {
      // 발음 평가 설정
      const pronunciationAssessmentConfig = new sdk.PronunciationAssessmentConfig(
        samples.find(s => s.id === selectedSample)?.text,
        sdk.PronunciationAssessmentGradingSystem.HundredMark,
        sdk.PronunciationAssessmentGranularity.Word,
        true
      );

      audioConfig.current = sdk.AudioConfig.fromDefaultMicrophoneInput();
      recognizer.current = new sdk.SpeechRecognizer(speechConfig.current, audioConfig.current);
      
      // 발음 평가 적용
      pronunciationAssessmentConfig.applyTo(recognizer.current);

      // 음성 레벨 모니터링
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);
      
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      const checkAudioLevel = () => {
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        setAudioLevel(average);
        if (isRecording) {
          requestAnimationFrame(checkAudioLevel);
        }
      };
      checkAudioLevel();

      // 음성 인식 및 평가 시작
      recognizer.current.recognized = (s, e) => {
        const pronunciationResult = sdk.PronunciationAssessmentResult.fromResult(e.result);
        
        setScore(pronunciationResult.pronunciationScore);
        setDetailedResults({
          accuracyScore: pronunciationResult.accuracyScore,
          fluencyScore: pronunciationResult.fluencyScore,
          completenessScore: pronunciationResult.completenessScore,
          prosodyScore: pronunciationResult.prosodyScore
        });
      };

      recognizer.current.startContinuousRecognitionAsync();
      setIsRecording(true);
      setTimer(30);
      
    } catch (err) {
      console.error('Error starting recording:', err);
    }
  };

  const stopRecording = () => {
    if (recognizer.current) {
      recognizer.current.stopContinuousRecognitionAsync();
      setIsRecording(false);
      setTimer(30);
    }
  };

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle className="text-2xl text-center">English Pronunciation Practice</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-6">
          {/* Sample Selection */}
          <div className="flex gap-2 flex-wrap justify-center">
            {samples.map(sample => (
              <Button
                key={sample.id}
                variant={selectedSample === sample.id ? "default" : "outline"}
                onClick={() => setSelectedSample(sample.id)}
              >
                Sample {sample.id}
              </Button>
            ))}
          </div>

          {/* Practice Text */}
          <div className="border rounded-lg p-4 bg-gray-50">
            <p className="text-lg text-center">
              {samples.find(s => s.id === selectedSample)?.text}
            </p>
          </div>

          {/* Controls */}
          <div className="flex justify-center gap-4">
            <Button
              onClick={playNativeSpeaker}
              disabled={isRecording || isPlaying}
              className="flex items-center gap-2"
            >
              <PlayCircle className="w-5 h-5" />
              Play Native Speaker
            </Button>
            
            {!isRecording ? (
              <Button
                onClick={startRecording}
                disabled={isPlaying}
                className="flex items-center gap-2"
              >
                <Mic className="w-5 h-5" />
                Start Speaking ({timer}s)
              </Button>
            ) : (
              <Button
                onClick={stopRecording}
                variant="destructive"
                className="flex items-center gap-2"
              >
                <StopCircle className="w-5 h-5" />
                Stop Recording
              </Button>
            )}
          </div>

          {/* Audio Level Indicator */}
          <div className="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
            <div
              className="h-full bg-blue-500 transition-all duration-100"
              style={{ width: `${(audioLevel / 255) * 100}%` }}
            />
          </div>

          {/* Detailed Results */}
          {detailedResults && (
            <div className="space-y-4">
              <div className="text-2xl font-bold text-center">
                Overall Score: {score?.toFixed(1)}%
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="border rounded p-3">
                  <div className="font-semibold">Accuracy</div>
                  <div className="text-xl">{detailedResults.accuracyScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Fluency</div>
                  <div className="text-xl">{detailedResults.fluencyScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Completeness</div>
                  <div className="text-xl">{detailedResults.completenessScore?.toFixed(1)}%</div>
                </div>
                <div className="border rounded p-3">
                  <div className="font-semibold">Prosody (Intonation)</div>
                  <div className="text-xl">{detailedResults.prosodyScore?.toFixed(1)}%</div>
                </div>
              </div>
              <div className="text-center text-gray-600">
                {score >= 90 ? 'Excellent pronunciation!' :
                 score >= 80 ? 'Very good pronunciation!' :
                 score >= 70 ? 'Good pronunciation, keep practicing!' :
                 'Keep practicing to improve your pronunciation!'}
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
};

export default PronunciationTrainer;
